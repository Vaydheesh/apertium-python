language: python
dist: xenial
cache:
    pip: true
    directories:
        - $PIPENV_CACHE_DIR
env:
    global:
        - PIPENV_CACHE_DIR=$HOME/.cache/pipenv
python:
    - '3.5'
    - '3.6'
    - '3.7'
    - 'nightly'
install:
    - pip install pipenv
    - travis_retry pipenv install --dev --system
before_script:
    - wget http://apertium.projectjj.com/apt/install-nightly.sh -O - | sudo bash
    - sudo apt-get -f --allow-unauthenticated install apertium-all-dev
    - sudo apt-get -f --allow-unauthenticated install apertium-nno-nob apertium-es-en apertium-eng
    - ./build-swig-wrapper.sh
script:
    - flake8 --verbose apertium
    - if [[ $TRAVIS_PYTHON_VERSION != 3.4 ]]; then
        mypy apertium --strict --any-exprs-report .mypy_coverage --ignore-missing-imports;
        cat .mypy_coverage/any-exprs.txt;
        coverage=$(tail -1 .mypy_coverage/any-exprs.txt | grep -Eo '[0-9\.]+%' | sed 's/%$//');
        if (( $(echo "$coverage < 95" | bc -l) )); then
            exit 1;
        fi;
      fi
    - coverage run -m unittest --verbose --buffer tests
    - coverage report --show-missing --fail-under 85 --include 'apertium/**'
after_success:
    - coveralls
notifications:
    on_failure: change
    on_success: change
matrix:
    allow_failures:
        - python: nightly
